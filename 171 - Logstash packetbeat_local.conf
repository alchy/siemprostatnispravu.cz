input {
  beats {
    port => 8981
    host => "localhost"
  }
}

filter {

  if ( "" in [client][ip] ) {
    mutate { add_field => { "[client][fqdn]" => "%{[client][ip]}" } }
    dns {
      reverse => [ "[client][fqdn]" ]
      action => "replace"
      hit_cache_size => 8192
      hit_cache_ttl => 300
    }
    cidr {
      address => [ "%{[client][ip]}" ]
      network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128","169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32" ]
      add_field => { "[client][locality]" => "private_range" }
    }
    if [client][locality] != "private_range" {
      geoip {
        source => "[client][ip]"
        target => "[client][geo]"
      }
    }
  }

  if ( "" in [source][ip] ) {
    mutate { add_field => { "[source][fqdn]" => "%{[source][ip]}" } }
    dns {
      reverse => [ "[source][fqdn]" ]
      action => "replace"
      hit_cache_size => 8192
      hit_cache_ttl => 300
    }
    cidr {
      address => [ "%{[source][ip]}" ]
      network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128","169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32" ]
      add_field => { "[source][locality]" => "private_range" }
    }
    if [source][locality] != "private_range" {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
      }
    }
  }

  if ( "" in [destination][ip] ) {
    mutate { add_field => { "[destination][fqdn]" => "%{[destination][ip]}" } }
    dns {
      reverse => [ "[destination][fqdn]" ]
      action => "replace"
      hit_cache_size => 8192
      hit_cache_ttl => 300
    }
    cidr {
      address => [ "%{[destination][ip]}" ]
      network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128","169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32" ]
      add_field => { "[destination][locality]" => "private_range" }
    }
    if [destination][locality] != "private_range" {
      geoip {
        source => "[destination][ip]"
        target => "[destination][geo]"
      }
    }
  }

  if ( "" in [server][ip] ) {
    mutate { add_field => { "[server][fqdn]" => "%{[server][ip]}" } }
    dns {
      reverse => [ "[server][fqdn]" ]
      action => "replace"
      hit_cache_size => 8192
      hit_cache_ttl => 300
    }
    cidr {
      address => [ "%{[server][ip]}" ]
      network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128","169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32" ]
      add_field => { "[server][locality]" => "private_range" }
    }
    if [server][locality] != "private_range" {
      geoip {
        source => "[server][ip]"
        target => "[server][geo]"
      }
    }
  }

  if ( "" in [host][ip] ) {
    mutate { add_field => { "[host][fqdn]" => "%{[host][ip]}" } }
    dns {
      reverse => [ "[host][fqdn]" ]
      action => "replace"
      hit_cache_size => 8192
      hit_cache_ttl => 300
    }
    cidr {
      address => [ "%{[host][ip]}" ]
      network => [ "0.0.0.0/32", "10.0.0.0/8", "172.16.0.0/12", "192.168.0.0/16", "fc00::/7", "127.0.0.0/8", "::1/128","169.254.0.0/16", "fe80::/10","224.0.0.0/4", "ff00::/8","255.255.255.255/32" ]
      add_field => { "[host][locality]" => "private_range" }
    }
    if [host][locality] != "private_range" {
      geoip {
        source => "[host][ip]"
        target => "[host][geo]"
      }
    }
  }

}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "%{[@metadata][beat]}-%{+YYYYMMdd}"
    user => "elastic"
    password => "SECRET"
  }
}
